@page "/person/{personId}/creditcard/create"

@inherits Component.ViewComponentBase

@using InitialEnterprise.BlazorFrontend.Controller
@using InitialEnterprise.Shared.Dtos
@using FluentValidation.Results

@inject CreditCardController Controller
@inject NavigationManager NavigationManager

    <form class="ui form">
        <h4 class="ui dividing header"><i class="globe icon"></i>Create Email</h4>
        <div class="field">
            <label>Card Holder</label>
            <div class="two fields">
                <div class="field">
                    <input type="text" @bind="@CreditCard.CreditCardHolderName" placeholder="Card Holder" />
                </div>
            </div>
        </div>
        <div class="field">
            <label>Card Number</label>
            <div class="two fields">
                <div class="field">
                    <input type="text" @bind="@CreditCard.CardNumber" placeholder="CardNumber" />
                </div>
            </div>
        </div>
        <div class="field">
            <label>Type</label>
            <div class="two fields">
                <div class="field">
                    <select class="ui dropdown" @bind="@CreditCard.CreditCardType">
                        @foreach (var cardType in this.CreditCardTypes)
                        {
                            <option value="@cardType.Name">@cardType.Name</option>
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="field">
            <div class="two fields">
                @*<div class="ui field checked checkbox">
                    <input type="checkbox" @bind="@CreditCard.IsPrimary" placeholder="IsPrimary" />
                    <label>Primary Mail</label>
                </div>*@
            </div>
        </div>
    </form>

<div class="ui small basic icon buttons">
    <button class="ui button" @onclick="@BackAction"><i class="reply icon"></i></button>
    <button class="ui button" @onclick="@SubmitAction"><i class="save icon"></i></button>
</div>

@code {
    [Parameter]
    public String PersonId { get; set; }

    CreditCardDto CreditCard = new CreditCardDto();

    ValidationResult validationResult = new ValidationResult();

    List<CreditCardTypeDto> CreditCardTypes = new List<CreditCardTypeDto>();

    protected override async Task OnInitializedAsync()
    {
        this.CreditCardTypes = await this.Controller.GetCreditCardTypes();
    }

    private Task SubmitAction()
    {
        return TryRun(async () =>
        {
            CommandHandlerAnswerDto<CreditCardDto> answer = await Controller.Save(CreditCard);
            {
                this.CreditCard = answer.AggregateRoot;
                this.validationResult = answer.ValidationResult;
            }
        });
    }

    private void BackAction()
    {
        NavigationManager.NavigateTo($"/person/edit/{this.PersonId}");
    }
}

